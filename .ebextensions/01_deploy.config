container_commands:

  01_install_composer:
    command: "composer.phar install --optimize-autoloader --no-dev"
  02_config_clear:
    command: "php artisan config:clear"
  03_view_clear:
    command: "php artisan view:clear"
  04_route_cache:
    command: "php artisan route:cache"
  05_view_cache:
    command: "php artisan view:cache"
  06_run_migrations:
    command: "php artisan migrate --force"
    leader_only: true

files:
  /opt/elasticbeanstalk/tasks/taillogs.d/laravel-logs.conf:
      content: /var/app/current/storage/logs/laravel.log
      group: root
      mode: "000644"
      owner: root
  /etc/systemd/system/laravel_queue_worker@.service:
      mode: "000644"
      owner: root
      group: root
      content: |
          [Unit]
          Description=Laravel queue worker

          [Service]
          User=webapp
          Group=webapp
          Restart=always
          EnvironmentFile=/opt/elasticbeanstalk/deployment/laravel_env
          ExecStart=/usr/bin/nohup /usr/bin/php /var/app/current/artisan queue:work

          [Install]
          WantedBy=multi-user.target

commands:
  remove_service_bak_file:
    command: "rm -f /etc/systemd/system/laravel_queue_worker@.service.bak"